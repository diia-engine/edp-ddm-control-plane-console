{{ define "registry/create.html" }}
    {{template "header" .}}
    <div class="registry registry-create">
        <div class="registry-header">
            <a href="{{ .BasePath }}/admin/registry/overview" class="registry-add">
                <img alt="add registry" src="{{ .BasePath }}/static/img/action-back.png" />
                <span>НАЗАД</span>
            </a>
        </div>
        <h1>Створити новий реєстр</h1>
        <div class="registry-description">Щоб створити реєстр, вкажіть його назву та додайте опис.</div>

        <form id="create-form" class="registry-create-form" method="post" enctype="multipart/form-data" action="">
            {{ if .error }}
            <div class="rc-global-error">{{.error}}</div>
            {{ end }}

            <div class="rc-title">
                Увага! Назва повинна бути унікальною і її неможливо буде змінити після створення реєстру!
            </div>
            <div class="rc-form-group {{ if .errorsMap.Name }}error{{end}}">
                <label for="name">Назва реєстру</label>
                <input type="text" id="name" name="name" maxlength="12" required
                       pattern="^[a-z0-9]([-a-z0-9]*[a-z0-9])?([a-z0-9]([-a-z0-9]*[a-z0-9])?)*$"
                       value="{{.model.Name}}" />
                <span>
                    {{range $key, $val := .errorsMap.Name}}
                        {{ i18n $val.Tag $val.Param }}
                    {{end}}
                </span>
                <p>Допустимі символи: "a-z", "-". Назва не може перевищувати довжину у 12 символів.</p>
            </div>
            <div class="rc-form-group {{ if .errorsMap.Admins }}error{{end}}">
                <label for="admins">Адміністратори</label>
                <input type="text" id="admins" name="admins" required pattern="^[a-zA-Z0-9@._\-,]+$"
                       value="{{.model.Admins}}" />
                <span>
                    {{range $key, $val := .errorsMap.Admins}}
                        {{ i18n $val.Tag $val.Param  }}
                    {{end}}
                </span>
                <p>Допустимі символи: "0-9", "a-z", "_", "-", "@", ".", ",".</p>
            </div>
            <div class="rc-form-group {{ if .errorsMap.Description }}error{{end}}">
                <label for="description">Опис</label>
                <textarea rows="3" name="description" id="description" maxlength="250">{{.model.Description}}</textarea>
                <span>{{range $key, $val := .errorsMap.Description}}{{ $val }}{{end}}</span>
                <p>Опис може містити офіційну назву реєстру чи його призначення.</p>
            </div>
            <div class="rc-form-group {{ if .errorsMap.RegistryGitTemplate }}error{{end}}">
                <label for="registry-git-template">Шаблон реєстру</label>
                <select required name="registry-git-template" id="registry-git-template">
                    <option></option>
                    {{range $key, $val := .gerritProjects}}
                        <option>{{$val.Spec.Name}}</option>
                    {{end}}
                </select>
                <span>{{range $key, $val := .errorsMap.RegistryGitTemplate}}{{ $val }}{{end}}</span>
            </div>
            <div class="rc-form-group {{ if .errorsMap.RegistryGitBranch }}error{{end}}">
                <label for="registry-git-branch">Гілка шаблону реєстру</label>
                <select required name="registry-git-branch" id="registry-git-branch">

                </select>
                <span>{{range $key, $val := .errorsMap.RegistryGitTemplate}}{{ $val }}{{end}}</span>
            </div>

            <div class="rc-form-group {{ if .errorsMap.RegistryGroup }}error{{end}}">
                <label for="registry-git-branch">Група реєстрів</label>
                <select name="registry-group" id="registry-group">
                    <option value="">Не додавати в групу</option>
                    {{range $key, $group := .groups}}
                        <option>{{ $group.Name }}</option>
                    {{end}}
                </select>
                <p>Створити нову групу можна у розділі "<a href="/admin/group/create">Групи реєстрів</a>".</p>
                <span>{{range $key, $val := .errorsMap.RegistryGroup}}{{ $val }}{{end}}</span>
            </div>


            {{template "key-form" .}}

            <div class="rc-form-group">
                <button type="submit" name="submit">Підтвердити</button>
            </div>
        </form>
    </div>
    <script src="{{ .BasePath }}/static/js/mustache.js"></script>
    <script id="ini-template" type="x-tmpl-mustache">
        {{ .hwINITemplateContent }}
    </script>
    <script id="allowed-keys-template" type="x-tmpl-mustache">
        <div class="allowed-keys-row">
            <input name="allowed-keys-issuer[]" class="allowed-keys-input allowed-keys-issuer" required aria-label="key issuer" placeholder="Емітент ключа" type="text" />
            <input name="allowed-keys-serial[]" class="allowed-keys-input allowed-keys-serial" required aria-label="key serial" placeholder="Серійний номер ключа" type="text" />
            <button class="allowed-keys-remove-btn">-</button>
        </div>
    </script>
    <script type="text/javascript">
        let registryBranches = {
            {{range $projectKey, $project := .gerritProjects}}
            "{{$project.Spec.Name}}": [
                {{range $branchKey, $branch := $project.Status.Branches}}
                "{{ $branch }}",
                {{end}}
            ],
            {{end}}
        };

        // let renderINITemplate = function (){
        //     let iniTemplate = document.getElementById('ini-template').innerHTML;
        //     let rendered = Mustache.render(iniTemplate, {
        //         "CA_NAME": $("#remote-ca-name").val(),
        //         "CA_HOST": $("#remote-ca-host").val(),
        //         "CA_PORT": $("#remote-ca-port").val(),
        //         "KEY_SN": $("#remote-serial-number").val(),
        //         "KEY_HOST": $("#remote-key-host").val(),
        //         "KEY_ADDRESS_MASK": $("#remote-key-mask").val(),
        //     });
        //
        //     $("#remote-ini-config").val(rendered.trim());
        // };

        $(function (){
            let registryGitTemplate = $("#registry-git-template");
            registryGitTemplate.change(function (e) {
                let tpl = $(e.target).val();
                let branches = registryBranches[tpl];
                let branchesSelect = $("#registry-git-branch");
                branchesSelect.empty();
                for (let branch in branches) {
                    let branchVal = branches[branch];
                    let headsIndex = branchVal.indexOf("heads/")
                    if (headsIndex !== -1) {
                        branchVal = branchVal.substring(headsIndex + 6)
                        branchesSelect.append(new Option(branchVal, branchVal));
                    }
                }
            });
            registryGitTemplate.change();

            $("#create-form").submit(function () {
                let registryNameInput = $("#name");
                if (registryNameInput.val().length < 3) {
                    registryNameInput.change();
                    return false;
                }
            });

            // let setValidationMessages = function(){
            //     let input = $(this).get(0);
            //     input.setCustomValidity('');
            //     let inputName = $(input).attr("name");
            //
            //     if (inputName === "name" && $(input).val().length < 3) {
            //         input.setAttribute("isvalid", "true")
            //         input.setCustomValidity('Будь-ласка вкажіть назву у відповідному форматі');
            //     }
            //
            //     if (!input.validity.valid) {
            //         input.scrollIntoView();
            //
            //         let errorMessages = {
            //             'name':   'Будь-ласка вкажіть назву у відповідному форматі',
            //             'key6': 'Будь-ласка оберіть файловий ключ',
            //             'sign-key-issuer': 'Будь-ласка вкажіть АЦСК, що видав ключ',
            //             'sign-key-pwd': 'Будь-ласка вкажіть пароль до файлового ключа',
            //             'ca-cert': 'Будь-ласка оберіть публічні сертифікати АЦСК',
            //             'ca-json': 'Будь-ласка оберіть список АЦСК',
            //             'admins': 'Будь-ласка вкажіть адміністраторів у відповідному форматі',
            //         };
            //         let errorMessage = errorMessages[inputName];
            //         if (errorMessage) {
            //             input.setCustomValidity(errorMessage);
            //         } else {
            //             input.setCustomValidity('Обов’язкове поле');
            //         }
            //     }
            // };
            //
            // $("input").on('change invalid', setValidationMessages);

            // let keyTypeChanged = function(e){
            //     let typeSections = $(".key-type-section");
            //     typeSections.find("input").prop('disabled', true);
            //     typeSections.hide();
            //
            //     let val = $(e.target).val(),
            //         visibleSection = $(`.key-type-${val}`);
            //     visibleSection.find('input').prop('disabled', false);
            //     visibleSection.show();
            // };
            // let keyDeviceType = $("#key-device-type");
            //
            // keyDeviceType.change(keyTypeChanged);
            // keyDeviceType.change();
            //
            // $(`.key-type-hardware`).find('input').change(renderINITemplate);
            // renderINITemplate();
            //
            // let removeAllowedKeysRow = function (e){
            //     $(e.target).parent().remove();
            //     return false;
            // };

            // $("#allowed-keys-add").click(function () {
            //     let iniTemplate = document.getElementById('allowed-keys-template').innerHTML;
            //     $("#allowed-keys-body").append(iniTemplate);
            //     let allowedKeysRemoveBtn = $(".allowed-keys-remove-btn");
            //     allowedKeysRemoveBtn.off();
            //     allowedKeysRemoveBtn.click(removeAllowedKeysRow);
            //
            //     $(".allowed-keys-input").on('change invalid', setValidationMessages);
            //
            //     return false;
            // });
        });
    </script>
    <script type="text/javascript" src="{{ .BasePath }}/static/js/registry-form.js"></script>
    {{template "footer" .}}

{{ end }}